{
  "version": 3,
  "sources": ["../../src/utils/db.utils.ts"],
  "sourcesContent": ["import { FastifyInstance, FastifyRequest } from 'fastify'\nimport { httpErrors } from '@fastify/sensible'\nimport { Connection, createConnection, IndexesDiff } from 'mongoose'\nimport { pickBy } from 'lodash/fp'\nimport promiseAll from 'promise-all'\nimport { IRestOptions } from '../mrq.interfaces'\nimport { SCHEMA_NOT_REGISTERED } from '../mrq.errors'\n\nconst pool: { [key: string]: Connection } = {}\n\nexport async function getDB(\n  app: FastifyInstance,\n  uri: string,\n  schemas: IRestOptions['schemas']\n) {\n  let conn: Connection = pool[uri]\n\n  if (!conn) {\n    conn = createConnection(uri, { autoIndex: false })\n\n    await conn.asPromise()\n\n    pool[uri] = conn\n\n    await mapModels(app, conn, schemas)\n  }\n\n  return conn\n}\n\nasync function mapModels(\n  app: FastifyInstance,\n  conn: Connection,\n  schemas: IRestOptions['schemas']\n) {\n  const p: { [modelName: string]: Promise<IndexesDiff> } = {}\n\n  conn.securePathsPerModel = {}\n\n  for (const modelName in schemas) {\n    const { schema } = schemas[modelName]\n\n    if (modelName in conn.models) continue\n\n    const Model = conn.model(modelName, schema)\n\n    p[modelName] = Model.diffIndexes()\n\n    schema.eachPath((path, schemaType) => {\n      if (!conn.securePathsPerModel[modelName])\n        conn.securePathsPerModel[modelName] = {}\n\n      if (schemaType.options.secure)\n        conn.securePathsPerModel[modelName][path] = true\n    })\n  }\n\n  const diffs = await promiseAll(p).then(\n    pickBy<IndexesDiff>((v, k) => v.toDrop.length || v.toCreate.length)\n  )\n\n  const hasAnyDiff = Object.keys(diffs).length\n\n  if (hasAnyDiff)\n    app.log.info('Result of diffIndexes:', JSON.stringify(diffs, null, 2))\n}\n\nexport async function closeConnections() {\n  const p = []\n\n  for (const uri in pool) p.push(pool[uri].close())\n\n  await Promise.allSettled(p)\n}\n\nexport function model(req: FastifyRequest, modelName: string) {\n  const Model = req.mongoose_conn.models[modelName]\n\n  if (!Model) throw httpErrors.badRequest(SCHEMA_NOT_REGISTERED)\n\n  return Model\n}\n"],
  "mappings": "AACA,SAAS,kBAAkB;AAC3B,SAAqB,wBAAqC;AAC1D,SAAS,cAAc;AACvB,OAAO,gBAAgB;AAEvB,SAAS,6BAA6B;AAEtC,MAAM,OAAsC,CAAC;AAE7C,eAAsB,MACpB,KACA,KACA,SACA;AACA,MAAI,OAAmB,KAAK,GAAG;AAE/B,MAAI,CAAC,MAAM;AACT,WAAO,iBAAiB,KAAK,EAAE,WAAW,MAAM,CAAC;AAEjD,UAAM,KAAK,UAAU;AAErB,SAAK,GAAG,IAAI;AAEZ,UAAM,UAAU,KAAK,MAAM,OAAO;AAAA,EACpC;AAEA,SAAO;AACT;AAEA,eAAe,UACb,KACA,MACA,SACA;AACA,QAAM,IAAmD,CAAC;AAE1D,OAAK,sBAAsB,CAAC;AAE5B,aAAW,aAAa,SAAS;AAC/B,UAAM,EAAE,OAAO,IAAI,QAAQ,SAAS;AAEpC,QAAI,aAAa,KAAK,OAAQ;AAE9B,UAAM,QAAQ,KAAK,MAAM,WAAW,MAAM;AAE1C,MAAE,SAAS,IAAI,MAAM,YAAY;AAEjC,WAAO,SAAS,CAAC,MAAM,eAAe;AACpC,UAAI,CAAC,KAAK,oBAAoB,SAAS;AACrC,aAAK,oBAAoB,SAAS,IAAI,CAAC;AAEzC,UAAI,WAAW,QAAQ;AACrB,aAAK,oBAAoB,SAAS,EAAE,IAAI,IAAI;AAAA,IAChD,CAAC;AAAA,EACH;AAEA,QAAM,QAAQ,MAAM,WAAW,CAAC,EAAE;AAAA,IAChC,OAAoB,CAAC,GAAG,MAAM,EAAE,OAAO,UAAU,EAAE,SAAS,MAAM;AAAA,EACpE;AAEA,QAAM,aAAa,OAAO,KAAK,KAAK,EAAE;AAEtC,MAAI;AACF,QAAI,IAAI,KAAK,0BAA0B,KAAK,UAAU,OAAO,MAAM,CAAC,CAAC;AACzE;AAEA,eAAsB,mBAAmB;AACvC,QAAM,IAAI,CAAC;AAEX,aAAW,OAAO,KAAM,GAAE,KAAK,KAAK,GAAG,EAAE,MAAM,CAAC;AAEhD,QAAM,QAAQ,WAAW,CAAC;AAC5B;AAEO,SAAS,MAAM,KAAqB,WAAmB;AAC5D,QAAM,QAAQ,IAAI,cAAc,OAAO,SAAS;AAEhD,MAAI,CAAC,MAAO,OAAM,WAAW,WAAW,qBAAqB;AAE7D,SAAO;AACT;",
  "names": []
}
