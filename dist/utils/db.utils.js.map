{
  "version": 3,
  "sources": ["../../src/utils/db.utils.ts", "../../src/mrq.errors.ts", "../../src/mrq.config.ts"],
  "sourcesContent": ["import { FastifyInstance, FastifyRequest } from 'fastify'\nimport { httpErrors } from '@fastify/sensible'\nimport { Connection, createConnection, IndexesDiff } from 'mongoose'\nimport fp from 'lodash/fp'\nimport promiseAll from 'promise-all'\nimport { IRestOptions } from '../mrq.interfaces'\nimport { SCHEMA_NOT_REGISTERED } from '../mrq.errors'\nimport { store } from '../mrq.config'\n\nconst pool: { [key: string]: Connection } = {}\n\nlet singleConnection: Connection | null = null\n\nexport async function getSingleConnection(\n  app: FastifyInstance,\n  opts: IRestOptions\n) {\n  if (!store.mongoPath) return\n  singleConnection = await getDB(app, store.mongoPath, opts.schemas)\n}\n\nexport async function getDB(\n  app: FastifyInstance,\n  uri: string,\n  schemas: IRestOptions['schemas']\n) {\n  if (singleConnection) return singleConnection\n\n  let conn: Connection = pool[uri]\n\n  if (!conn) {\n    conn = createConnection(uri, { autoIndex: false })\n\n    await conn.asPromise()\n\n    pool[uri] = conn\n\n    await mapModels(app, conn, schemas)\n  }\n\n  return conn\n}\n\nasync function mapModels(\n  app: FastifyInstance,\n  conn: Connection,\n  schemas: IRestOptions['schemas']\n) {\n  const p: { [modelName: string]: Promise<IndexesDiff> } = {}\n\n  conn.securePathsPerModel = {}\n\n  for (const modelName in schemas) {\n    const { schema } = schemas[modelName]\n\n    if (modelName in conn.models) continue\n\n    const Model = conn.model(modelName, schema)\n\n    p[modelName] = Model.diffIndexes()\n\n    schema.eachPath((path, schemaType) => {\n      if (!conn.securePathsPerModel[modelName])\n        conn.securePathsPerModel[modelName] = {}\n\n      if (schemaType.options.secure)\n        conn.securePathsPerModel[modelName][path] = true\n    })\n  }\n\n  const diffs = await promiseAll(p).then(\n    fp.pickBy<IndexesDiff>((v, k) => v.toDrop.length || v.toCreate.length)\n  )\n\n  const hasAnyDiff = Object.keys(diffs).length\n\n  if (hasAnyDiff)\n    app.log.info('Result of diffIndexes:', JSON.stringify(diffs, null, 2))\n}\n\nexport async function closeConnections() {\n  const p = []\n\n  for (const uri in pool) p.push(pool[uri].close())\n\n  await Promise.allSettled(p)\n}\n\nexport function model(req: FastifyRequest, modelName: string) {\n  const Model = req.mongooseConn.models[modelName]\n\n  if (!Model) throw httpErrors.badRequest(SCHEMA_NOT_REGISTERED)\n\n  return Model\n}\n", "export const SCHEMA_NOT_REGISTERED = 'SCHEMA_NOT_REGISTERED'\n\nexport const SESSION_NOT_FOUND = 'SESSION_NOT_FOUND'\n\nexport const IMPLICIT_SELECT_ALL_NOT_ALLOWED = 'IMPLICIT_SELECT_ALL_NOT_ALLOWED'\n\nexport const ROLE_DOES_NOT_HAVE_ACCESS_HOOK_LEVEL =\n  'ROLE_DOES_NOT_HAVE_ACCESS_HOOK_LEVEL'\n\nexport const ROLE_DOES_NOT_HAVE_ACCESS_HANDLER_LEVEL =\n  'ROLE_DOES_NOT_HAVE_ACCESS_HANDLER_LEVEL'\n\nexport const PATH_NOT_FOUND_IN_SCHEMA = 'PATH_NOT_FOUND_IN_SCHEMA'\n\nexport const IMPLICIT_DELETE_ALL_NOT_ALLOWED = 'IMPLICIT_DELETE_ALL_NOT_ALLOWED'\n\nexport const NO_DOCUMENT_FOUND = 'NO_DOCUMENT_FOUND'\n\nexport const INVALID_BODY = 'INVALID_BODY'\n\nexport const EMPTY_BODY = 'EMPTY_BODY'\n\nexport const DOCUMENT_NOT_FOUND = 'DOCUMENT_NOT_FOUND'\n\nexport const SUBARRAY_NOT_FOUND = 'SUBARRAY_NOT_FOUND'\n\nexport const NO_SUBITEM_FOUND = 'NO_SUBITEM_FOUND'\n\nexport const SUBITEM_NOT_FOUND = 'SUBITEM_NOT_FOUND'\n", "export const leanOptions = {\n  virtuals: true,\n  versionKey: false,\n}\n\nexport const toJSONOptions = {\n  virtuals: true,\n  versionKey: false,\n}\n\nexport const memoOptions = {\n  maxAge: 30 * 24 * 60 * 60 * 1_000, // 1 month\n}\n\nexport const store = { mongoPath: '' }\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,sBAA2B;AAC3B,sBAA0D;AAC1D,gBAAe;AACf,yBAAuB;;;ACJhB,IAAM,wBAAwB;;;ACU9B,IAAM,cAAc;AAAA,EACzB,QAAQ,KAAK,KAAK,KAAK,KAAK;AAAA;AAC9B;AAEO,IAAM,QAAQ,EAAE,WAAW,GAAG;;;AFLrC,IAAM,OAAsC,CAAC;AAE7C,IAAI,mBAAsC;AAE1C,eAAsB,oBACpB,KACA,MACA;AACA,MAAI,CAAC,MAAM,UAAW;AACtB,qBAAmB,MAAM,MAAM,KAAK,MAAM,WAAW,KAAK,OAAO;AACnE;AAEA,eAAsB,MACpB,KACA,KACA,SACA;AACA,MAAI,iBAAkB,QAAO;AAE7B,MAAI,OAAmB,KAAK,GAAG;AAE/B,MAAI,CAAC,MAAM;AACT,eAAO,kCAAiB,KAAK,EAAE,WAAW,MAAM,CAAC;AAEjD,UAAM,KAAK,UAAU;AAErB,SAAK,GAAG,IAAI;AAEZ,UAAM,UAAU,KAAK,MAAM,OAAO;AAAA,EACpC;AAEA,SAAO;AACT;AAEA,eAAe,UACb,KACA,MACA,SACA;AACA,QAAM,IAAmD,CAAC;AAE1D,OAAK,sBAAsB,CAAC;AAE5B,aAAW,aAAa,SAAS;AAC/B,UAAM,EAAE,OAAO,IAAI,QAAQ,SAAS;AAEpC,QAAI,aAAa,KAAK,OAAQ;AAE9B,UAAM,QAAQ,KAAK,MAAM,WAAW,MAAM;AAE1C,MAAE,SAAS,IAAI,MAAM,YAAY;AAEjC,WAAO,SAAS,CAAC,MAAM,eAAe;AACpC,UAAI,CAAC,KAAK,oBAAoB,SAAS;AACrC,aAAK,oBAAoB,SAAS,IAAI,CAAC;AAEzC,UAAI,WAAW,QAAQ;AACrB,aAAK,oBAAoB,SAAS,EAAE,IAAI,IAAI;AAAA,IAChD,CAAC;AAAA,EACH;AAEA,QAAM,QAAQ,UAAM,mBAAAA,SAAW,CAAC,EAAE;AAAA,IAChC,UAAAC,QAAG,OAAoB,CAAC,GAAG,MAAM,EAAE,OAAO,UAAU,EAAE,SAAS,MAAM;AAAA,EACvE;AAEA,QAAM,aAAa,OAAO,KAAK,KAAK,EAAE;AAEtC,MAAI;AACF,QAAI,IAAI,KAAK,0BAA0B,KAAK,UAAU,OAAO,MAAM,CAAC,CAAC;AACzE;AAEA,eAAsB,mBAAmB;AACvC,QAAM,IAAI,CAAC;AAEX,aAAW,OAAO,KAAM,GAAE,KAAK,KAAK,GAAG,EAAE,MAAM,CAAC;AAEhD,QAAM,QAAQ,WAAW,CAAC;AAC5B;AAEO,SAAS,MAAM,KAAqB,WAAmB;AAC5D,QAAM,QAAQ,IAAI,aAAa,OAAO,SAAS;AAE/C,MAAI,CAAC,MAAO,OAAM,2BAAW,WAAW,qBAAqB;AAE7D,SAAO;AACT;",
  "names": ["promiseAll", "fp"]
}
